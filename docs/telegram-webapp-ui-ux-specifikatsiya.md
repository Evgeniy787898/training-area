# Telegram WebApp — UI/UX-спецификация

## Цели и охват
WebApp дополняет чат-бота визуальными экранами для просмотра плана, прогресса и аналитики. Приложение запускается из инлайн-кнопок или через меню бота и должно работать в мобильном Telegram-клиенте.

## Навигация и информация архитектуры
- Нижняя навигационная панель с пятью вкладками: «Сегодня», «План недели», «Отчёт», «Прогресс», «Настройки».
- Глобальная кнопка возврата в чат и статус-секция с активным `trace_id` запроса.
- Состояния загрузки: skeleton-компоненты для списков, спиннер для графиков.
- Ошибки отображаются в toast-уведомлениях с возможностью повторить запрос.
- Wireframe-описание:
  - **AppBar** (48px): название экрана + кнопка «в чат».
  - **Content**: вертикальный скролл, блоки с карточками (карточка = 16px padding, радиус 12px, тень Level 1).
  - **BottomNav** (56px): иконка + подпись (12px), активный элемент подсвечен акцентным цветом, inactive — #718096.
  - **Empty State**: иконка 64px, заголовок 18px, подсказка 14px + кнопка CTA.

## Пользовательские сценарии (User Flows)
- **Открытие из чата → отметка тренировки**:
  1. Пользователь нажимает инлайн-кнопку «Открыть план».
  2. WebApp загружается с вкладкой «Сегодня» и prefetch «План недели».
  3. Пользователь отмечает упражнение как выполненное, WebApp отправляет `session_marked_done` (PUT `/v1/sessions/{id}`), показывает toast «Отправлено», предлагает закрыть приложение.
- **Просмотр прогресса → запрос аналитики**:
  1. Из вкладки «Прогресс» пользователь переключает диапазон на 30 дней.
  2. WebApp запрашивает `/v1/reports/volume_trend?range=30d` (кэш 15 минут).
  3. Нажатие «Открыть в чате» формирует deep-link `tg://resolve?...` с параметром `report=volume_trend` и закрывает WebApp.
- **Изменение настроек**:
  1. Пользователь переходит в «Настройки», меняет время уведомлений и включает паузу.
  2. WebApp делает PATCH `/v1/profile/preferences`.
  3. Успешный ответ закрывает модалку подтверждения, показывает toast. Ошибка — toast с кодом и кнопкой «Повторить».
- **Повторный заход (deeplink)**: deep-link `.../webapp?tab=report` сразу активирует вкладку «Отчёт» и подставляет данные последней сессии.
- **Ошибка сети**: при отсутствии сети на «Прогресс» отображается офлайн-экран с кнопками «Повторить» и «Вернуться в чат», успешное подключение автоматически перезапускает запрос.

## Экран «Сегодня»
- Заголовок с датой и уровнем нагрузки на день.
- Карточки упражнений: название, подходы/повторы, RPE, таймеры отдыха.
- CTA-кнопки: «Отметить выполнено», «Отложить», «Открыть замену».
- Состояние пустого дня: сообщение о дне отдыха и переход к «Прогресс».
- Состояния карточек:
  - `planned` — голубая рамка, кнопка «Начать».
  - `in_progress` — жёлтая рамка, таймер активен, кнопка «Пауза».
  - `done` — зелёная заливка, галочка, возможность откатить («Отменить выполнение»).
- Skeleton: три карточки 120px высотой с анимированным shimmer.

## Экран «План недели»
- Календари с полосой прогресса по дням.
- Возможность пролистывать недели свайпами.
- Каждая карточка дня содержит краткое описание и индикатор, была ли тренировка выполнена.
- Контекстное меню для отката версии (переход к чату с командой `PLAN_REVERT`).
- Состояния карточек дня:
  - `future` — серый фон, только краткая информация.
  - `today` — подсветка акцентом, кнопка «Открыть в чате».
  - `completed` — зелёный чек и процент выполнения.
- Интерактив «потяни вниз для обновления» (pull-to-refresh) с задержкой не более 1 сек.

## Экран «Отчёт»
- Форма с выбором тренировки/дня, шкалой RPE (1–10), полем заметок.
- Предустановленные шаблоны ответов («Слишком тяжело», «Нужно увеличить вес»).
- Кнопка отправки формирует событие `report_submitted` с данными и закрывает WebApp.
- Валидация: без выбранной тренировки кнопка disabled; RPE по умолчанию 7, допускается ввод дробных значений (шаг 0.5).
- При отправке отображается confirm-экран с итогами и кнопкой «Вернуться в чат».

## Экран «Прогресс»
- Графики объёма, RPE и уровней сложностей (данные приходят из кэшированного каталога отчётов).
- Возможность переключать диапазоны (7 дней, 30 дней, кастомный).
- Кнопка «Открыть в чате» создаёт deep-link для запроса той же аналитики.
- Каждая карточка графика содержит: заголовок, переключатель диапазона, канву (минимум 220px), текстовый summary.
- При плохой связи отображается заглушка «Не удалось загрузить график» + кнопка «Повторить».
- Дополнительно: таблица последних достижений (3 записи, скролл).

## Экран «Настройки»
- Единственный контрол «Время уведомлений»: time picker, переключатель часового пояса.
- Информация о правилах выходных и паузах уведомлений.
- Кнопка «Сохранить» подтверждает изменения и показывает toast «Время уведомлений обновлено».
- Режим «пауза уведомлений» (toggle) с пояснением длительности (по умолчанию 7 дней).
- Подтверждение изменений: модальное окно с резюме «07:30 (GMT+3), выходные +1 час».

## Дизайн-стандарты
- Цветовая схема: основной цвет — #2B6CB0, акцент — #68D391, фон — #F7FAFC.
- Шрифты: Inter 16px для текста, 20px для заголовков.
- Кнопки имеют радиус скругления 12px, тени уровня 1.
- Поддержка тёмной темы Telegram: цвета инвертируются согласно гайдлайнам.
- Все интерактивные элементы доступны по табу и имеют фокус-стили.
- Минимальные интервалы между элементами: вертикальный отступ 12px, горизонтальный 16px.
- Анимации (fade/slide) ≤ 150 мс, чтобы не задерживать UX.

## Доступность
- Контраст текста ≥ 4.5:1.
- Контент читаем без масштабирования до 200%.
- Для графиков есть текстовые описания («Прогресс по объёму: +12% за 30 дней»).
- Все кнопки имеют aria-label (например, «Вернуться в чат», «Переключить диапазон на 30 дней»).
- Компоненты поддерживают управление клавиатурой: таб → фокус, Enter/Space → действие, Esc → закрытие модалок.

## Протокол WebApp ↔ бот
- **Инициализация**: бот отправляет payload с `user_id`, `trace_id`, `auth_token` (подписанный JWT) и локалью.
- **События из WebApp**: `open_report`, `report_submitted`, `settings_updated`, `analytics_opened`.
- **Ответы бота**: ack с кодом статуса, обновлённые данные, уведомления о конфликте версий.
- **Кэширование**: WebApp хранит данные в sessionStorage не более 15 минут.
- **Безопасность**: каждая отправка подписывается HMAC с использованием секретного ключа бота.
- **Схема payload**:
  - `report_submitted` → `{ "event": "report_submitted", "trace_id": "uuid", "payload": { "session_id": "uuid", "rpe": 7.5, "notes": "...", "symptoms": ["плечо"] } }`.
  - `settings_updated` → `{ "event": "settings_updated", "payload": { "notification_time": "07:30", "timezone": "Europe/Moscow", "pause_until": "2024-06-01" } }`.
  - `analytics_opened` → `{ "event": "analytics_opened", "payload": { "report": "volume_trend", "range": "30d" } }`.
- Все payload валидируются через Zod-схемы; при ошибке отправляется `error` с кодом `validation_failed` и описанием.
- Таймаут ожидания ответа от бота — 5 секунд; при превышении WebApp показывает toast «Нет ответа, попробуй ещё раз».

### Версионирование API и обработка устаревших payload
- **Версия API**: все запросы используют префикс `/v1`. Несовместимые изменения выводятся в `/v2` с параллельной поддержкой не менее 30 дней.
- **Контроль клиента**: WebApp отправляет заголовок `X-Client-Version`; бот проверяет таблицу совместимости. При устаревшей версии возвращается `client_update_required` с инструкцией обновиться.
- **Неизвестные поля**: игнорируются, фиксируются в `webapp_events` (категория `unknown_field`); отсутствие обязательных полей приводит к `validation_failed`.
- **Коды ошибок**:
  | Код | Описание | Действие WebApp |
  | --- | --- | --- |
  | `validation_failed` | Некорректные данные | Показать toast, подсветить поле |
  | `auth_expired` | Истёк токен | Запросить `expand.getAuthData`, повторить |
  | `conflict` | Конфликт версий плана | Показать модалку с CTA «Открыть чат» |
  | `rate_limited` | Превышен лимит | Запустить таймер 30 сек и повторить |
  | `server_error` | Внутренняя ошибка | Предложить повторить или вернуться в чат |
  | `client_update_required` | Клиент устарел | Показать баннер с инструкцией обновить WebApp |

## Производительность и бюджеты
- **Размеры**: общий размер JS-бандла ≤ 250 КБ gzip, критический CSS ≤ 30 КБ. Графики и тяжёлые зависимости загружаются лениво после первого взаимодействия.
- **Время запуска**: TTI ≤ 2.5 с на устройствах среднего класса (Android 10, 4G). Первые интерактивные элементы должны реагировать ≤ 1.5 с.
- **Сеть**: запросы используют HTTP/2, включено сжатие JSON. Ответы кэшируются через `Cache-Control: max-age=900`; повторные открытия вкладок используют кэш.
- **Производительность UI**: анимации bottom sheet и свайпов ≥ 50 FPS, графики ограничивают количество точек до 60–80, при превышении включается агрегация.
- **Метрики**: Lighthouse Performance ≥ 80, FCP < 1.5 с, CLS < 0.1. WebApp отправляет `web-vitals` в Supabase `webapp_metrics` и строит дешборд по FID/INP.

## Сценарии отказов
- Нет сети: WebApp показывает офлайн-экран и предлагает вернуться к чату.
- Истёк токен: запрос обновления токена через метод `expand.getAuthData` Telegram.
- Сбой API: fallback на отправку текстового отчёта через чат.
- Лимиты производительности: если время рендеринга графика > 1200 мс, приложение переключается на упрощённый режим (табличный вывод).
- При загрузке > 3 МБ данных подряд WebApp предупреждает «Большой объём данных, аналитика может открываться дольше».
