# Telegram WebApp — спецификация реализации

Документ описывает текущее состояние Telegram WebApp и служит руководством для разработки и поддержки. Приложение запускается из чата бота и работает внутри Telegram-клиента.

## Общая структура

- **Навигация**: нижняя панель с семью вкладками — «Сегодня», «План недели», «Отчёт», «Прогресс», «Упражнения», «Справка», «Настройки».
- **Статус-бар**: в шапке отображается имя пользователя, метка регулярности и последний `trace_id` HTTP-запроса.
- **Состояния загрузки**: для списков и карточек используются skeleton-компоненты (анимированные серые блоки).
- **Уведомления**: информирование о результатах операций реализовано через toasts (нижняя часть экрана).
- **Адаптивность**: ширина контента ограничена 600px, на широких экранах карточки центрируются.
- **Фолбэк**: при недоступности API отображается локальный пример плана/каталога с предупреждением в toast.
- **Standalone-режим**: при открытии в браузере вместо Telegram показывается карточка-инструкция с ссылкой в чат (если задан `VITE_BOT_USERNAME`).

## Пользовательские сценарии

### Просмотр плана на сегодня
1. Пользователь открывает WebApp из чата.
2. Приложение вызывает `GET /v1/sessions/today` и показывает карточку тренировки.
3. Кнопка «Отметить выполненной» отправляет `PUT /v1/sessions/{id}` с `status = done`. При успехе отображается toast и данные обновляются.
4. Кнопка «Перенести» показывает подсказку вернуться в чат и написать соответствующую команду.

### Просмотр плана на неделю
1. Экран «План недели» запрашивает `GET /v1/sessions/week` (с датой недели).
2. Карточки дней отражают состояние: `planned`, `done`, `skipped`, `rest`, текущий день подсвечен.
3. Кнопки навигации позволяют перелистывать недели (±7 дней).
4. Кнопка «Перейти к “Сегодня”» переключает вкладку на детальную карточку дня.
5. Если план не найден в базе, показывается статический план из Supabase `dialog_states`.

### Отправка отчёта
1. Экран «Отчёт» напоминает шаги заполнения команды `/report` в чате.
2. При нажатии «Вернуться в чат» WebApp закрывается и показывает toast с подсказкой.

### Прогресс и аналитика
1. Экран «Прогресс» одновременно запрашивает:
   - `GET /v1/reports/volume_trend?range=30d`
   - `GET /v1/reports/rpe_distribution?range=30d`
   - `GET /v1/achievements`
2. Диаграммы строятся с помощью Recharts: линейный график объёма и столбчатая диаграмма распределения RPE.
3. Статистика отображает регулярность (из `/v1/profile/summary`), средний объём и долю тяжёлых тренировок.
4. Список достижений показывает до 10 последних записей.

### Каталог упражнений
1. Экран «Упражнения» запрашивает `GET /v1/exercises/catalog` и отображает карточки прогрессий.
2. При выборе карточки загружается история `GET /v1/exercises/{exerciseKey}/history` и показываются уровни.
3. Если API недоступно, используется локальный справочник с шортлистом знаний и показывается предупреждение.

### Информационный стенд
1. Экран «Справка» отображает статический набор карточек с принципами тренировок, прогрессии и восстановления.
2. Контент собирается локально, без запросов к API, и служит шпаргалкой после обновления плана.
3. Из раздела доступны быстрые подсказки (мини-комплекс, шкала RPE, советы по восстановлению).

### Настройки
1. Значения по умолчанию берутся из `/v1/profile/summary` (`notification_time`, `timezone`, `notifications_paused`).
2. Изменения отправляются запросом `PATCH /v1/profile/preferences`.
3. После успешного сохранения показывается toast, данные профиля перезагружаются.

## UI-компоненты

- **Карточки тренировок**: содержат тип сессии, источник данных (Supabase/базовый план), список упражнений и CTA-кнопки.
- **Skeleton**: набор прямоугольников с анимацией shimmer, используется на всех вкладках во время загрузки.
- **Toast**: содержит иконку, заголовок, опционально текст и `trace_id` при ошибке. Самостоятельно исчезает через 3.5 секунды.
- **Формы**: поля ввода и select имеют скругление 8px, фокус-подсветка соответствует гайдлайнам Telegram (border-primary).
- **Цветовая схема**: primary `#2B6CB0`, accent `#68D391`, фон `#F7FAFC`.

## Доступность

- Все интерактивные элементы имеют `aria-label` (навигация, кнопки обновления, чекбоксы).
- Для графиков предусмотрены текстовые подписи (сводка над графиками).
- Контраст текста и фона не ниже 4.5:1.
- Toast-уведомления объявлены через `aria-live="polite"`.

## Сетевые запросы

- Базовый URL считывается из `VITE_API_BASE_URL` (например, `http://localhost:3000`).
- Идентификация и проверка выполняются через заголовки `X-Telegram-Id` и `X-Telegram-Init-Data` (подпись Telegram WebApp).
- На каждую ошибку показывается toast с `trace_id` из ответа.
- Подробные схемы запросов и ответов см. в `docs/api-schema.md`.

## Ограничения и дальнейшие шаги

- Редактирование конкретных упражнений и обновление прогрессии выполняются в чате (WebApp отображает данные только для чтения).
- Экран «Отчёт» работает как навигация в чат — форма в WebApp не реализована.
- Для улучшения UX можно добавить автоматическое обновление данных при возврате из чата (через `Telegram.WebApp.onEvent('viewportChanged', ...)`).
- При открытии вне Telegram пользователь получает инструкцию вернуться в чат с прямой ссылкой на бота.

Документ обновляется синхронно с изменениями WebApp. При добавлении нового экрана или API-эндпоинта необходимо описать пользовательский сценарий и требования к UI в этом файле.
