# Логика прогрессии и работы ИИ

Документ описывает, как бот анализирует выполненные тренировки, обновляет прогрессии упражнений и использует историю, чтобы формировать персональные рекомендации. Правила диалогового поведения и протоколы безопасности вынесены в отдельный файл [«Правила поведения и интентов ИИ-тренера»](pravila-ii-i-dialoga.md).

## Термины
- **Уровень упражнения** — целевые подходы и повторения, необходимые для перехода к следующей стадии развития навыка.
- **Прогрессия** — последовательность уровней для одного упражнения. Может быть линейной (фиксированные ступени) или гибкой (есть базовые правила увеличения нагрузки без строгих уровней).
- **Сессия** — тренировка в конкретный день с перечнем упражнений, подходов, повторений, субъективных оценок (RPE) и заметок.
- **История** — агрегированная информация о последних N (по умолчанию 10) сессиях: достигнутые уровни, пропуски, усталость, рекорды.

## Общий поток данных прогрессии
1. Пользователь выполняет тренировку и отправляет отчёт `/report`.
2. Бот сохраняет сырые данные по каждому упражнению: фактические подходы/повторы, комментарии, RPE, отметки о самочувствии.
3. Модуль анализа прогрессии сравнивает факт выполнения с целевыми параметрами текущего уровня.
4. На основе правил перехода определяется, стоит ли продвинуть уровень, закрепить его или сделать шаг назад.
5. Решение записывается в Supabase и передаётся планировщику (ChatGPT) при генерации следующего плана.

## Правила оценки выполнения
### Упражнения с фиксированными уровнями
- **Успех**: выполнено ≥ 105% целевого объёма и RPE ≤ 7. Результат — продвижение на следующий уровень.
- **Закрепление**: выполнено от 90% до 105% целевого объёма или RPE 8–9. Результат — повторить уровень на следующей тренировке.
- **Откат**: выполнено < 90% целевого объёма, RPE ≥ 10 или отметка о боли. Результат — вернуться на предыдущий уровень или снизить объём на 10–20%.

#### Типы упражнений
- **Силовые** (подтягивания, отжимания, приседания): шаг по уровню = +1 подход или +2 повторения; допустимая скорость роста — не чаще чем через две успешные сессии.
- **Выносливость** (планка, кардио-блоки): шаг = +10% времени/объёма, условие продвижения — RPE ≤ 6 дважды подряд.
- **Мобилизация** (мостик, растяжка): шаг = увеличение амплитуды или сложности вариации, RPE не применяется — прогресс оценивается по субъективной шкале комфорта (0–5).

### Упражнения без уровней
- Хранится целевой диапазон повторений и подходов (например, 3×8–12).
- При превышении верхней границы диапазона три сессии подряд бот увеличивает нагрузку: добавляет подход, усложняет вариацию или советует утяжеление.
- При систематическом недовыполнении бот предлагает облегчённую вариацию, уменьшает объём или добавляет подсказки по технике.
- Для смешанных сессий (сочетание фиксированных и гибких прогрессий) распределение адаптации следующее: сначала корректируется гибкая часть (±1 подход/повтор), затем при стабильности меняется фиксированный уровень.

### Дополнительные факторы
- **Пропуски**: если упражнение пропущено больше одного раза подряд, уровень не повышается до двух стабильных выполнений.
- **Техника**: при отметке «проблема с техникой» прогрессия замораживается, добавляются вспомогательные упражнения или ссылки на обучающие материалы.

## Обновление планов
1. После анализа прогрессии формируется объект `progress_update` с решением (перейти, закрепить, откатить), новым целевым уровнем и комментариями.
2. Edge Function `update_plan` формирует системный промпт для ChatGPT с краткой сводкой по упражнению, решением алгоритма и ограничениями (доступное оборудование, расписание, усталость).
3. ChatGPT возвращает обновлённый план. Бот сохраняет его в Supabase и отправляет пользователю сводку с пояснениями.

## Использование истории ИИ
- История хранится в таблицах `training_sessions` и `exercise_progress`.
- `exercise_progress` включает поля: `session_id`, `exercise_key`, `level_target`, `level_result`, `volume_target`, `volume_actual`, `rpe`, `notes`, `decision`, `streak_success`.
- При генерации плана ChatGPT получает компактную сводку: текущий уровень, результаты трёх последних сессий, тенденция по RPE, наличие пропусков.
- Для еженедельных и ежемесячных отчётов строятся тренды по объёму, прогрессу уровней и субъективной нагрузке.
- **Хранение и очистка**: записи `exercise_progress` старше 18 месяцев архивируются в таблицу `exercise_progress_archive`, а агрегированные метрики (`rolling_volume`, `rolling_rpe`) пересчитываются раз в неделю. Очистка запускается Edge Function `archive_progress` по расписанию (воскресенье 23:00).
- **Лимиты хранения**: если число записей на пользователя > 10 000, архивирование запускается вне расписания, а бот уведомляет о возможной задержке аналитики.

## Логика рекомендаций на следующую тренировку
| Сценарий | Поведение бота |
| --- | --- |
| Перевыполнение без высокой усталости | Предложить следующий уровень, добавить мотивационное сообщение |
| Выполнение на грани | Предложить выбор: повторить уровень или попробовать следующий с предупреждением |
| Недовыполнение | Указать, сколько повторений/подходов не хватило, предложить облегчённую вариацию |
| Слишком высокое RPE | Снизить объём на 10–15%, добавить рекомендации по восстановлению |
| Пропуск | Напомнить о регулярности, предложить вернуться к предыдущему уровню |

## Интеграция с диалогами
- Системный промпт ChatGPT содержит инструкцию использовать историю прогрессии, упоминать конкретные уровни и объёмы, предлагать варианты адаптации.
- Сообщения пользователя анализируются на признаки усталости или боли; при их наличии ставится флаг `fatigue_flag`, который влияет на следующий ответ и план.
- Контекст последнего диалога сохраняется в таблице `dialog_context`, чтобы после перезапуска бота продолжать разговор с учётом предыдущих рекомендаций.
- При ручной коррекции (пользователь просит «убери последние подходы») запись помечается флагом `manual_override`. Алгоритм приоритетов: `manual_override` > автоматическое решение прогрессии > дефолтное значение плана. Каждая правка логируется в `plan_version_audit` с указанием автора и причины.
- Конфликты между ручным и автоматическим решением решаются следующим образом:
  1. Если ручная правка и автоматическое решение произошли в течение 24 часов — приоритет за ручной правкой, автоматическое решение откладывается на следующую сессию.
  2. Если ручная правка старше 24 часов, а новая аналитика противоречит ей, бот запрашивает подтверждение и предлагает компромисс (среднее значение нагрузки).
  3. Все нерешённые конфликты отображаются в еженедельном обзоре с предложением принять одно из решений.

## Псевдокод анализа прогрессии
```pseudo
for exercise in session.exercises:
  baseline = get_current_level(exercise)
  target_volume = baseline.sets * baseline.reps
  actual_volume = exercise.completed_sets * exercise.completed_reps
  effort = exercise.rpe

  if exercise.skipped:
    decision = 'hold'
  else if actual_volume >= target_volume * 1.05 and effort <= 7:
    decision = 'advance'
  else if actual_volume >= target_volume * 0.9 and effort <= 9:
    decision = 'hold'
  else:
    decision = 'regress'

  decision = adjust_for_history(decision, history_streaks, fatigue_flags)
  save_progress(exercise, decision)
```

## План расширения
- Добавить адаптивный коэффициент сложности на основе динамики RPE: при стабильном снижении RPE повышать целевой объём.
- Реализовать модель прогнозирования недовыполнений (например, градиентный бустинг по истории), чтобы корректировать план заранее.
- Включить рекомендации по восстановлению (сон, питание) при частом высоком RPE или отметках о боли.
- Создать визуализации прогрессии (графики) в еженедельных и ежемесячных отчётах.
