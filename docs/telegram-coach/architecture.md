# Архитектура и технические решения

## Стек
- **Node.js 20+** — основа для бота и серверных утилит.
- **grammY** — надёжный Telegram-фреймворк с поддержкой inline-клавиатур.
- **OpenAI Responses API** — генерирует тексты тренировок (модель `gpt-4.1-mini`).
- **Supabase** — хранение профиля, сессий и метрик.
- **Zod** — строгая валидация входных данных.

## Модули проекта
- `src/bot/telegramBot.js` — точка входа Telegram-бота: настраивает grammY, поднимает BotEngine и обрабатывает команды.
- `src/bot/botEngine.js` — маршрутизация сообщений, контроль безопасности, логика приветствия и обновлений профиля.
- `src/training/trainingCoach.js` — интеграция OpenAI с Supabase, фиксация сессий и генерация планов.
- `src/training/progressRepository.js` — доступ к таблицам Supabase.
- `src/training/exerciseCatalog.js` — описания упражнений для подсказок в промпте.
- `src/services/promptFactory.js` — формирование подробного промпта для ИИ.
- `supabase/migrations/20241023153000_create_training_tables.sql` — схема данных для профиля, сессий и метрик.

## Конфигурация окружения
Создаю файл `.env` со следующими переменными:

```
NODE_ENV=development
LOG_LEVEL=info
TELEGRAM_BOT_TOKEN=***
OPENAI_API_KEY=sk-***
OPENAI_ORGANIZATION=
OPENAI_PROJECT=
SUPABASE_URL=https://***.supabase.co
SUPABASE_ANON_KEY=***
ERROR_TRACKING_DSN=
```

Никакие реальные ключи не коммичу, храню только локально.

## Поток обработки сообщения
1. grammY получает апдейт и превращает текст в объект для BotEngine.
2. BotEngine очищает текст, проверяет чувствительные данные, ищет директивы `цель:` и `готовность:`.
3. TrainingCoach создаёт или обновляет профиль в Supabase, собирает историю последних 5 сессий.
4. PromptFactory формирует персональный промпт, OpenAI возвращает структурированный ответ.
5. TrainingCoach записывает новую тренировочную сессию и отдаёт текст обратно пользователю.
6. Телеграм-бот отправляет ответ вместе с inline-кнопками для быстрого обновления состояния.

## Observability
- `MetricsTracker` собирает метрики по каналам, чтобы при необходимости подключить Prometheus.
- `ErrorTracker` можно связать с Sentry через `ERROR_TRACKING_DSN`.
- Эндпоинты `/health` и `/metrics` остаются в `server/index.js` для будущего продакшн-деплоя.

## Развёртывание
1. Локально проверяю работу с `npm run bot`.
2. Для продакшена поднимаю Node-процесс (PM2, Docker или Supabase Edge Function для вебхука).
3. Настраиваю HTTPS вебхук в Telegram, если нужен режим без long polling.
4. Добавляю мониторинг и алертинг, если переношу на сервер.

## Безопасность
- Токены и ключи только в переменных окружения.
- BotEngine блокирует сообщения с потенциальными секретами.
- Supabase таблицы используют UUID и каскадное удаление, чтобы мои данные не протекали.
