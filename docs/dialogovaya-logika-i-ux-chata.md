# Диалоговая логика и UX чата

## Цели
Обеспечить понятный опыт общения с ботом, где свободный текст распознаётся NLU, но пользователь всегда понимает доступные функции.

### Реализация (апрель 2024)
- В боте подключён rule-based NLU (`server/services/nlu.js`), распознающий ключевые intents: просмотр плана, отчёт, статистика, перенос, напоминание, мотивация и режим восстановления.
- Свободный текст в `server/bot/index.js` направляется в соответствующие сценарии: запуск /plan, запуск отчёта, вызов подробной статистики, запуск редакторов настроек и сценария переноса.
- Перенос тренировки реализован в `server/bot/commands/reschedule.js`: пользователь выбирает дату из нескольких вариантов или переносит «на завтра» одной фразой.
- Команда `/settings` позволяет оперативно менять время уведомлений и паузу; цели и оборудование отображаются только для справки.
- Интент «напомни позже» создаёт запись в `dialog_states` (`reminder_followup`) и отвечает пользователю с указанием времени следующего пинга.
- Режим восстановления фиксируется состоянием `recovery_mode` на 14 дней и влияет на дальнейшие подсказки.

## Форматы запросов
- Свободные запросы: «Перенеси тренировку на завтра», «Покажи прогресс за месяц», «Измени напоминание на 7:30».
- Командные запросы: `/start`, `/plan`, `/report`, `/stats`, `/settings`, `/help`.
- Смешанные сообщения: текст + эмодзи, уточняющие вопросы («а можно полегче?») — NLU должен извлекать intent и слоты.
- Последовательные запросы: поддерживается цепочка «опрос → уточнение → подтверждение» с сохранением контекста до 5 минут.

## Ответы бота
- Структура: краткое подтверждение + основные данные + CTA (кнопка или инструкция).
- Форматирование: MarkdownV2, эмодзи для статусов (✅ выполнено, ⚠️ требуется внимание).
- При запросах аналитики: ссылка на WebApp + вложение картинки (если доступно).
- Тон: один мотивационный тезис и одно конкретное действие, без лишних общих фраз.

## Шаблоны сообщений
- **Подтверждение действия**: «Готово! Тренировку на *среду* перенёс на *четверг*.»
- **Запрос дополнительных данных**: «Уточни, пожалуйста, на какое время поставить уведомление?»
- **Ошибка**: «Такой возможности пока нет. Доступные действия: план, отчёт, прогресс, настройки.»
- **Хелп**: список команд, описание ключевых возможностей и кнопка «Открыть WebApp».
- **Сценарий «Отчёт о тренировке»**:
  1. `Бот`: «Как прошла тренировка *{дата}?* Напиши, что сделал по каждому упражнению.»
  2. `Пользователь`: «Подтягивания 3×8, отжимания 2×12.»
  3. `Бот`: «Записал! Теперь оцени нагрузку по RPE.»
  4. `Пользователь`: «RPE 8.»
  5. `Бот`: «Спасибо! ✅ Фиксирую выполнение и обновляю прогрессию.»
- **Сценарий «Перенос тренировки»**:
  1. `Пользователь`: «Перенеси сегодняшнюю тренировку.»
  2. `Бот`: «Могу перенести на завтра или воскресенье. Что выберешь?»
  3. `Пользователь`: «На воскресенье.»
  4. `Бот`: «Готово! 🔁 Тренировку перенёс на воскресенье, график обновил.»
- **Сценарий «Настройки уведомлений»**:
  1. `Пользователь`: «Напоминание в 7:30.»
  2. `Бот`: «Поставить уведомление на 07:30 Europe/Moscow?» (кнопки «Да», «Нет»)
  3. `Пользователь`: «Да.»
  4. `Бот`: «Супер! Уведомления теперь приходят в 07:30. Чтобы изменить — напиши «сменить напоминание».»
- **Сценарий «Онбординг /start»**:
  1. `Бот`: приветствие с именем пользователя, короткое обещание ценности («Помогу тренироваться последовательно и без боли»), кнопка «Поехали».
  2. `Бот`: задаёт вопросы в фиксированном порядке: цель (кнопки «Силовая выносливость», «Рельеф», «Здоровье»), доступное оборудование (чекбокс-лист), ограничения (свободный текст), предпочтительное время тренировок (кнопки «Утро», «День», «Вечер»).
  3. `Бот`: резюмирует ответы, запрашивает подтверждение («Всё верно?» с кнопками «Да/Изменить»).
  4. `Бот`: показывает, как пользоваться ботом (карточка с командами `/plan`, `/report`, `/stats`, `/settings`, CTA «Открыть план в WebApp»).
  5. `Бот`: закрепляет сообщение с планом первой недели и отправляет напоминание «Если захочешь перенести тренировку или получить статистику — просто напиши об этом».

## Инлайн-кнопки и меню
- Кнопки быстрого доступа к WebApp экранам: «Сегодня», «План недели», «Отчёт», «Прогресс», «Настройки».
- Контекстные кнопки в диалогах: «Подтвердить», «Отменить», «Подробнее в WebApp».
- Меню команд (`/menu`): дублирует основную функциональность и отображает хелп.

## Дополнительные сценарии
- **Аналитика /stats**: бот уточняет период («За какой период показать прогресс?», кнопки «Неделя», «Месяц», «Выбрать даты»), после выбора отправляет изображение отчёта и текстовый TL;DR (главный вывод, тренд, рекомендация). В `dialog_states` сохраняется `stats:last_range`, чтобы повторные запросы подхватывали прошлый диапазон.
- **Справка /help**: структура — секция «Что умею» (3–5 основных возможностей), секция «Попробуй сказать» (пример фраз), кнопка «Открыть WebApp». При повторном вызове за сутки выводится блок «Что нового» (если есть записи в changelog) и счётчик доступных отчётов.
- **Режим восстановления**: intent `recovery_mode` активируется фразами «Я простыл», «Болит плечо». Бот уточняет симптом (кнопки «Боль», «Усталость», «Травма»), длительность, разрешение на лёгкие тренировки. Состояние хранится 14 дней, по истечении бот спрашивает «Готов вернуться к обычным тренировкам?».
- **Команда «Есть ли время?»**: intent `schedule_check` — бот анализирует план на неделю и отвечает, когда ближайшее свободное окно (берёт данные из `plan_version_items`). При отсутствии слотов предлагает «Сместить тренировку?» с переходом в сценарий переноса.
- **Напоминание позже**: intent `remind_later` — бот уточняет интервал («Через час», «Вечером», «Завтра утром») и ставит запись в `dialog_states` с `expires_at = now() + выбранный интервал`. После триггера отправляет сообщение и очищает состояние.

## Эскалация в WebApp
- Для сложных сценариев (просмотр детальной аналитики, редактирование плана) бот предлагает перейти в WebApp, передавая `trace_id` и параметры запроса.
- После закрытия WebApp бот присылает резюме выполненных действий.

## Обработка ошибок
- **Неизвестный intent**: ответ «Такой возможности пока нет», перечисление 3–5 основных возможностей и кнопка `/help`.
- **Неполные параметры**: бот уточняет недостающие данные, сохраняет контекст последнего запроса 5 минут.
- **Системные ошибки**: извинение, информация о повторной попытке, при длительном сбое — предложение выполнить действие вручную в WebApp.
- **Квоты**: если достигнут лимит OpenAI (429), бот сообщает «Сейчас очередь запросов к ИИ занята, повторю через 1 минуту» и ставит повтор в очередь.

## Контекст и состояние
- Сессии в Redis/Supabase для хранения текущего диалога (до 10 сообщений истории).
- Указание активной версии плана в каждом ответе, если запрос связан с тренировками.
- При завершении действия бот резюмирует изменения и напоминает про `/help`.
- Для длинных диалогов (>5 сообщений) бот отправляет промежуточное резюме и спрашивает, нужно ли продолжать.
- Если пользователь молчит >10 минут в активном сценарии, бот отправляет напоминание и закрывает контекст («Продолжим позже, просто напиши, когда будешь готов.»).
- При возобновлении через >24 часа бот предлагает TL;DR последнего шага и уточняет, актуальны ли прошлые договорённости.

## UX-наблюдения
- Важные ответы закрепляются (pin) в чате (например, обновлённый план на неделю).
- Раз в неделю бот отправляет «Что нового» с подсказкой по возможностям NLU.
- Пользователь может в любой момент запросить «Что ты умеешь?» — ответ идентичен `/help`.
- Допустимая длина ответа: до 900 символов или 12 строк, чтобы не закрывать экран.
- Среднее время на уточнение: ≤ 5 секунд обработки + 2 сообщения, логируется в метрику `dialog_clarity`.
- NPS-оценка UX: раз в месяц бот спрашивает «Было ли удобно планировать тренировки?» (кнопки 1–5), результаты сохраняются в `metrics` с типом `ux_nps`.

## Машина состояний и восстановление контекста
- **Слои состояния**: глобальный (`GLOBAL_IDLE`, `REPORTING`, `PLANNING`, `SETTINGS`), сцены (внутри `REPORTING`: `ASK_SESSION`, `ASK_RPE`, `ASK_NOTES`, `SUMMARY`) и временные флаги (например, `awaiting_feedback`).
- **Переходы**:
  | Текущее состояние | Вход | Следующее состояние | Действие |
  | --- | --- | --- | --- |
  | `GLOBAL_IDLE` | `/report` | `REPORTING.ASK_SESSION` | Отобразить список тренировок и инлайн-кнопки |
  | `REPORTING.ASK_SESSION` | Выбор тренировки | `REPORTING.ASK_RPE` | Сохранить идентификатор сессии |
  | `REPORTING.ASK_RPE` | Число 1–10 или кнопка | `REPORTING.ASK_NOTES` | Провести валидацию диапазона |
  | `REPORTING.ASK_NOTES` | Текст/кнопка «Пропустить» | `REPORTING.SUMMARY` | Сформировать JSON отчёта |
  | Любое состояние | Команда `/cancel` | `GLOBAL_IDLE` | Очистить временное состояние, показать подсказку |
- **Восстановление**: при таймауте 15 минут Wizard перезапускается с последней подтверждённой точки. Хранение контекста — Supabase `dialog_states` (`profile_id`, `scene`, `payload`, `expires_at`). При рестарте бот повторяет последний вопрос и отображает введённые данные.
- **Fallback**: при несоответствии контекста (например, устаревшая кнопка) бот переходит в `GLOBAL_IDLE`, отправляет «Сцена устарела, начнём сначала?» и прикрепляет соответствующий call-to-action.
- **Управление TTL**: записи в `dialog_states` имеют `expires_at`, вычисленный из типа сцены (базовые сценарии — 15 минут, напоминания — до 24 часов, режим восстановления — до 14 дней). Job `cleanup_dialog_states` запускается каждые 30 минут и удаляет устаревшие записи. Максимальный размер `state_payload` — 8 КБ; при попытке превышения бот отправляет ссылку на WebApp.
- **История сообщений**: для каждого `trace_id` хранится до 20 последних сообщений (текст + метаданные) в `dialog_states.history`. При коллизии (второй запрос того же intent до завершения первого) бот сравнивает `updated_at`: если текущий контекст старше 2 минут, он сбрасывается и пользователь видит сообщение «Похоже, мы начали новую тему, продолжим с нуля».

## Метрики UX и логирование
- **Основные метрики**: время до завершения сценария отчёта, доля пользователей, которые досылают RPE, completion rate онбординга, количество отмен по `/cancel`.
- **A/B тесты**: вариантные промпты и макеты кнопок обозначаются флагами `ab_group` в `dialog_states`. Логи сохраняются в `dialog_events` (`event_type`, `event_payload`, `ab_group`, `timestamp`).
- **Качественные сигналы**: тегирование сообщений пользователя метками `confusion`, `praise`, `frustration` на основе словаря. Для каждой метки заводится задача в Notion/Jira с приоритетом в зависимости от частоты.
- **Мониторинг**: дешборд в Grafana строит воронку по сценам FSM и выдаёт алерты, если конверсия падает > 10% относительно базовой недели.

## Обработка граничных случаев
- **Длинные сообщения**: текст > 1000 символов режется, пользователю предлагается отправить краткое резюме или открыть WebApp для подробностей.
- **Нецензурная лексика**: фильтр `bad_words` помечает сообщение, бот отвечает нейтрально и предлагает переформулировать. При повторении ≥ 3 раз включается safety-инструктаж и запись события `safety_violation`.
- **Медиа и голос**: фото/видео сопровождаются запросом «Хочешь добавить заметку?». Голосовые сообщения транскрибируются через Whisper Edge Function (ограничение 90 секунд), результат сохраняется в отчёте.
- **Отсутствие ответа**: если пользователь не реагирует на вопрос > 2 часа, бот шлёт мягкое напоминание с кнопкой «Пропустить». После трёх напоминаний сцена закрывается.
- **Мультимодальные запросы**: при отправке комбинации текста и медиа приоритет отдаётся тексту; медиа отмечается как дополнительный контент. WebApp получает ссылки на файлы с истечением 24 часа.
