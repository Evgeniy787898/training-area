# Диалоговая логика и UX чата

## Цели
Обеспечить понятный опыт общения с ботом, где свободный текст распознаётся NLU, но пользователь всегда понимает доступные функции.

## Форматы запросов
- Свободные запросы: «Перенеси тренировку на завтра», «Покажи прогресс за месяц», «Измени напоминание на 7:30».
- Командные запросы: `/start`, `/plan`, `/report`, `/stats`, `/settings`, `/help`.
- Смешанные сообщения: текст + эмодзи, уточняющие вопросы («а можно полегче?») — NLU должен извлекать intent и слоты.

## Ответы бота
- Структура: краткое подтверждение + основные данные + CTA (кнопка или инструкция).
- Форматирование: MarkdownV2, эмодзи для статусов (✅ выполнено, ⚠️ требуется внимание).
- При запросах аналитики: ссылка на WebApp + вложение картинки (если доступно).

## Шаблоны сообщений
- **Подтверждение действия**: «Готово! Тренировку на *среду* перенёс на *четверг*.»
- **Запрос дополнительных данных**: «Уточни, пожалуйста, на какое время поставить уведомление?»
- **Ошибка**: «Такой возможности пока нет. Доступные действия: план, отчёт, прогресс, настройки.»
- **Хелп**: список команд, описание ключевых возможностей и кнопка «Открыть WebApp».

## Инлайн-кнопки и меню
- Кнопки быстрого доступа к WebApp экранам: «Сегодня», «План недели», «Отчёт», «Прогресс», «Настройки».
- Контекстные кнопки в диалогах: «Подтвердить», «Отменить», «Подробнее в WebApp».
- Меню команд (`/menu`): дублирует основную функциональность и отображает хелп.

## Эскалация в WebApp
- Для сложных сценариев (просмотр детальной аналитики, редактирование плана) бот предлагает перейти в WebApp, передавая `trace_id` и параметры запроса.
- После закрытия WebApp бот присылает резюме выполненных действий.

## Обработка ошибок
- **Неизвестный intent**: ответ «Такой возможности пока нет», перечисление 3–5 основных возможностей и кнопка `/help`.
- **Неполные параметры**: бот уточняет недостающие данные, сохраняет контекст последнего запроса 5 минут.
- **Системные ошибки**: извинение, информация о повторной попытке, при длительном сбое — предложение выполнить действие вручную в WebApp.

## Контекст и состояние
- Сессии в Redis/Supabase для хранения текущего диалога (до 10 сообщений истории).
- Указание активной версии плана в каждом ответе, если запрос связан с тренировками.
- При завершении действия бот резюмирует изменения и напоминает про `/help`.

## UX-наблюдения
- Важные ответы закрепляются (pin) в чате (например, обновлённый план на неделю).
- Раз в неделю бот отправляет «Что нового» с подсказкой по возможностям NLU.
- Пользователь может в любой момент запросить «Что ты умеешь?» — ответ идентичен `/help`.
